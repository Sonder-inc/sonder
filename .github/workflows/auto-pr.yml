name: Auto PR

on:
  issues:
    types: [opened, labeled]
  repository_dispatch:
    types: [feedback_submitted]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'repository_dispatch' ||
      contains(github.event.issue.labels.*.name, 'security') ||
      contains(github.event.issue.labels.*.name, 'bug') ||
      contains(github.event.issue.labels.*.name, 'needs-fix') ||
      contains(github.event.issue.labels.*.name, 'automated')

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install
        working-directory: cli

      - name: Setup Git
        run: |
          git config user.name "sonder-bot"
          git config user.email "bot@sonder.dev"

      - name: Get issue context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "source=feedback" >> $GITHUB_OUTPUT
            echo "title=${{ github.event.client_payload.title }}" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.client_payload.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "source=issue" >> $GITHUB_OUTPUT
            echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Create fix with Sonder
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.context.outputs.title }}
          ISSUE_BODY: ${{ steps.context.outputs.body }}
          SOURCE: ${{ steps.context.outputs.source }}
        run: |
          BRANCH_NAME="auto/fix-$(date +%s)"

          if [ -n "$ISSUE_NUMBER" ]; then
            CLOSES_REF="Closes #${ISSUE_NUMBER}"
          else
            CLOSES_REF=""
          fi

          PROMPT="You are a senior developer. Create a PR to fix this:

          **Source:** ${SOURCE}
          **Title:** ${ISSUE_TITLE}
          **Details:**
          ${ISSUE_BODY}

          ## Your task

          1. Search the codebase to understand the issue
          2. Create branch: git checkout -b ${BRANCH_NAME}
          3. Make minimal, focused changes to fix the issue
          4. Test your changes compile: bun run typecheck
          5. Commit with message: fix: <brief description>
          6. Push and create PR:

          gh pr create \\
            --title \"fix: \${ISSUE_TITLE}\" \\
            --body \"\$(cat <<'PREOF'
          ## Summary
          <1-2 sentences explaining the fix>

          ## Changes
          - <bullet points of what changed>

          ## Test Plan
          - [ ] Typecheck passes
          - [ ] Manual testing

          ${CLOSES_REF}

          ---
          *Auto-generated by Sonder*
          PREOF
          )\"

          IMPORTANT: Only make changes directly related to the issue. Do not refactor unrelated code."

          bun run cli/src/index.tsx --headless "$PROMPT"

      - name: Comment on issue
        if: steps.context.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr list --head "auto/fix-*" --json url -q '.[0].url' 2>/dev/null || echo "")

          if [ -n "$PR_URL" ]; then
            gh issue comment ${{ steps.context.outputs.issue_number }} \
              --body "ðŸ¤– Created PR to fix this issue: ${PR_URL}"
          else
            gh issue comment ${{ steps.context.outputs.issue_number }} \
              --body "ðŸ¤– Attempted auto-fix but couldn't create PR. May need human review."
          fi
